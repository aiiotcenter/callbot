services:
  callbot:
    build:
      context: .
      dockerfile: dockerfile
    image: callbot:local
    container_name: callbot
    restart: unless-stopped
    env_file:
      - .env
    environment:
      AGENTS_STORE_PATH: /app/agents/agents.json
    ports:
      - "8765:8765"
    volumes:
      - ./admin-dashboard/data:/app/agents:ro
    read_only: true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=64m
    healthcheck:
      test:
        - CMD
        - node
        - -e
        - fetch('http://127.0.0.1:8765/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s
  admin-dashboard:
    build:
      context: ./admin-dashboard
      dockerfile: Dockerfile
    image: callbot-admin-dashboard:local
    container_name: callbot-admin-dashboard
    user: "${UID:-1000}:${GID:-1000}"
    restart: unless-stopped
    env_file:
      - .env
    environment:
      NODE_ENV: production
    volumes:
      - ./admin-dashboard/data:/app/data
    ports:
      - "3000:3000"
